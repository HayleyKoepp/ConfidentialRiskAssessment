<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confidential Risk Assessment System</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <!-- Backup CDN in case primary fails -->
    <script>
        if (typeof ethers === 'undefined') {
            console.log('Primary ethers CDN failed, loading backup...');
            document.write('<script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"><\/script>');
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
            min-height: 100vh;
            color: #333;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3), transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(138, 43, 226, 0.3), transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.4);
            font-weight: 700;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, #fff 0%, #e0e7ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .wallet-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .wallet-info {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.08) 100%);
            border-radius: 16px;
            padding: 25px;
            color: white;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.25);
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .connection-steps {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.06) 100%);
            border-radius: 16px;
            padding: 25px;
            color: white;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 25px;
            text-align: left;
            font-size: 0.9rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        .connection-steps h3 {
            margin-bottom: 15px;
            text-align: center;
        }

        .connection-steps ol {
            margin-left: 20px;
        }

        .connection-steps li {
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.95) 100%);
            border-radius: 20px;
            padding: 35px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.2), 0 5px 15px rgba(126, 34, 206, 0.15);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(10px);
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 60px rgba(0,0,0,0.25), 0 8px 20px rgba(126, 34, 206, 0.25);
        }

        .card h2 {
            color: #1e293b;
            margin-bottom: 25px;
            font-size: 1.9rem;
            font-weight: 700;
            border-bottom: 3px solid transparent;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, transparent 100%);
            background-size: 100% 3px;
            background-repeat: no-repeat;
            background-position: bottom;
            padding-bottom: 12px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.8);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #7e22ce;
            box-shadow: 0 0 0 4px rgba(126, 34, 206, 0.15);
            background: rgba(255,255,255,1);
            transform: translateY(-2px);
        }

        .risk-slider {
            margin: 10px 0;
        }

        .risk-slider input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }

        .risk-value {
            text-align: center;
            font-weight: 700;
            font-size: 1.3rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-top: 8px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }

        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-connect {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            margin-bottom: 20px;
            font-size: 18px;
            padding: 18px 35px;
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
            border-radius: 14px;
        }

        .btn-connect:hover:not(:disabled) {
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.6);
        }

        .status {
            background: #f7fafc;
            border-left: 4px solid #4299e1;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .status.error {
            border-left-color: #f56565;
            background: #fed7d7;
        }

        .status.success {
            border-left-color: #48bb78;
            background: #c6f6d5;
        }

        .status.loading {
            border-left-color: #ed8936;
            background: #feebc8;
        }

        .assessment-list {
            grid-column: 1 / -1;
        }

        .assessment-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 18px;
            margin: 12px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .assessment-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(126, 34, 206, 0.15);
            border-color: #c4b5fd;
        }

        .risk-indicator {
            padding: 8px 18px;
            border-radius: 25px;
            color: white;
            font-weight: 700;
            font-size: 13px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .risk-low {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .risk-medium {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        .risk-high {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }

        .feature-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.08) 100%);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            color: white;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.25);
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .feature-card h3 {
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .feature-card p {
            opacity: 0.9;
            line-height: 1.5;
        }

        .contract-info {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.06) 100%);
            border-radius: 16px;
            padding: 20px;
            color: white;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 25px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        .hidden {
            display: none;
        }

        .network-info {
            background: rgba(72, 187, 120, 0.1);
            border: 1px solid rgba(72, 187, 120, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            color: #2f855a;
            font-size: 0.9rem;
        }

        .step-indicator {
            display: inline-block;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            text-align: center;
            font-size: 12px;
            font-weight: 700;
            line-height: 24px;
            margin-right: 10px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .card {
                padding: 20px;
            }

            .connection-steps {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîí Confidential Risk Assessment System</h1>
            <p>Privacy-Preserving Risk Evaluation System using Zama FHE Technology</p>
        </div>

        <div class="contract-info">
            <strong>Contract Address:</strong> 0x4C8A88dB129bCFFA79024c59dfDe83090a5B7fF6<br>
            <strong>Required Network:</strong> <span id="networkName">Sepolia Testnet (Chain ID: 11155111)</span><br>
            <strong>Contract Status:</strong> <span id="contractStatus">Checking...</span>
        </div>

        <div class="connection-steps" id="connectionSteps">
            <h3>üîó Wallet Connection Process</h3>
            <ol>
                <li><span class="step-indicator">1</span>Detection: Check for MetaMask provider (window.ethereum)</li>
                <li><span class="step-indicator">2</span>Request Access: Use eth_requestAccounts to get user permission</li>
                <li><span class="step-indicator">3</span>Network Verification: Verify connection to Sepolia Testnet (0xaa36a7)</li>
                <li><span class="step-indicator">4</span>Network Switch: Auto-switch/add Sepolia if needed</li>
                <li><span class="step-indicator">5</span>Provider Setup: Create ethers.js BrowserProvider and signer</li>
                <li><span class="step-indicator">6</span>Contract Initialization: Create contract instance</li>
                <li><span class="step-indicator">7</span>State Update: Update account and contract state</li>
            </ol>
            <div class="network-info">
                <strong>Success Handling:</strong> Display "Connected to Sepolia! ‚úÖ" message and show main interface
            </div>
        </div>

        <div class="wallet-section">
            <button class="btn btn-connect" id="connectBtn" onclick="connectWallet()">
                ü¶ä Connect MetaMask Wallet
            </button>
            <div class="wallet-info hidden" id="walletInfo">
                <strong>Connected Address:</strong> <span id="walletAddress"></span><br>
                <strong>ETH Balance:</strong> <span id="walletBalance"></span> ETH<br>
                <strong>Network:</strong> <span id="currentNetwork">Sepolia Testnet</span><br>
                <strong>User Role:</strong> <span id="userRole">Checking...</span>
            </div>
        </div>

        <div class="main-content hidden" id="mainInterface">
            <div class="card">
                <h2>üè¢ Company Registration</h2>
                <div class="form-group">
                    <label for="companyAddress">Company Ethereum Address:</label>
                    <input type="text" id="companyAddress" placeholder="0x... (42 characters)">
                </div>
                <div class="form-group">
                    <label for="industryRisk">Industry Risk Level (0-100):</label>
                    <div class="risk-slider">
                        <input type="range" id="industryRisk" min="0" max="100" value="50"
                               oninput="updateRiskValue('industryRisk', 'industryRiskValue')">
                        <div class="risk-value" id="industryRiskValue">50</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="companySize">Company Size (Number of Employees):</label>
                    <input type="number" id="companySize" placeholder="e.g., 100" min="1">
                </div>
                <div class="form-group">
                    <label for="geoRisk">Geographic Risk Level (0-100):</label>
                    <div class="risk-slider">
                        <input type="range" id="geoRisk" min="0" max="100" value="30"
                               oninput="updateRiskValue('geoRisk', 'geoRiskValue')">
                        <div class="risk-value" id="geoRiskValue">30</div>
                    </div>
                </div>
                <button class="btn" onclick="registerCompany()" id="registerBtn">
                    üìù Register Company
                </button>
            </div>

            <div class="card">
                <h2>üìä Create Risk Assessment</h2>
                <div class="form-group">
                    <label for="assessmentCompany">Target Company Address:</label>
                    <input type="text" id="assessmentCompany" placeholder="0x... (company to assess)">
                </div>
                <div class="form-group">
                    <label for="financialRisk">Financial Risk (0-100):</label>
                    <div class="risk-slider">
                        <input type="range" id="financialRisk" min="0" max="100" value="40"
                               oninput="updateRiskValue('financialRisk', 'financialRiskValue')">
                        <div class="risk-value" id="financialRiskValue">40</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="operationalRisk">Operational Risk (0-100):</label>
                    <div class="risk-slider">
                        <input type="range" id="operationalRisk" min="0" max="100" value="35"
                               oninput="updateRiskValue('operationalRisk', 'operationalRiskValue')">
                        <div class="risk-value" id="operationalRiskValue">35</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="reputationalRisk">Reputational Risk (0-100):</label>
                    <div class="risk-slider">
                        <input type="range" id="reputationalRisk" min="0" max="100" value="25"
                               oninput="updateRiskValue('reputationalRisk', 'reputationalRiskValue')">
                        <div class="risk-value" id="reputationalRiskValue">25</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="complianceRisk">Compliance Risk (0-100):</label>
                    <div class="risk-slider">
                        <input type="range" id="complianceRisk" min="0" max="100" value="20"
                               oninput="updateRiskValue('complianceRisk', 'complianceRiskValue')">
                        <div class="risk-value" id="complianceRiskValue">20</div>
                    </div>
                </div>
                <button class="btn" onclick="createAssessment()" id="assessBtn">
                    üîç Create Risk Assessment
                </button>
            </div>

            <div class="card assessment-list">
                <h2>üìà Assessment History</h2>
                <button class="btn" onclick="loadAssessments()" style="width: auto; margin-bottom: 20px;">
                    üîÑ Load Assessment History
                </button>
                <div id="assessmentsList">
                    <p style="text-align: center; color: #666; padding: 20px;">
                        Click "Load Assessment History" to view your risk assessment records.
                    </p>
                </div>
            </div>
        </div>

        <div class="feature-grid">
            <div class="feature-card">
                <h3>üîê Privacy-First Architecture</h3>
                <p>All risk data is encrypted using Zama's Fully Homomorphic Encryption (FHE) technology, ensuring complete confidentiality while enabling computations on encrypted data.</p>
            </div>
            <div class="feature-card">
                <h3>üìä Multi-Dimensional Analysis</h3>
                <p>Comprehensive risk assessment covering financial stability, operational efficiency, reputational standing, and regulatory compliance factors.</p>
            </div>
            <div class="feature-card">
                <h3>‚ö° Real-Time Processing</h3>
                <p>Instant encrypted computations and risk score calculations performed directly on the blockchain without exposing sensitive data.</p>
            </div>
            <div class="feature-card">
                <h3>üõ°Ô∏è Secure Comparisons</h3>
                <p>Compare risk levels between different companies without revealing actual assessment data using advanced cryptographic techniques.</p>
            </div>
        </div>

        <div id="status" class="status hidden">
            Ready to connect your wallet...
        </div>
    </div>

    <script>
        // Debug: Check if ethers is loaded
        console.log('Ethers availability check:', typeof ethers);
        if (typeof ethers === 'undefined') {
            alert('‚ùå Ethers.js failed to load! Please refresh the page.');
            throw new Error('Ethers.js not loaded');
        } else {
            console.log('‚úÖ Ethers.js loaded successfully:', ethers.version);
        }

        // Contract configuration
        const CONTRACT_ADDRESS = "0x4C8A88dB129bCFFA79024c59dfDe83090a5B7fF6";
        const SEPOLIA_CHAIN_ID = "0xaa36a7"; // 11155111 in hex
        const SEPOLIA_CHAIN_ID_DECIMAL = 11155111;

        const CONTRACT_ABI = [
            "function owner() view returns (address)",
            "function assessmentCounter() view returns (uint32)",
            "function authorizeAssessor(address assessor)",
            "function revokeAssessor(address assessor)",
            "function registerCompany(address company, uint8 industryRiskLevel, uint16 companySize, uint8 geographicRisk)",
            "function createRiskAssessment(address company, uint8 financialRisk, uint8 operationalRisk, uint8 reputationalRisk, uint8 complianceRisk)",
            "function updateCompanyProfile(address company, uint8 industryRiskLevel, uint16 companySize, uint8 geographicRisk)",
            "function getCompanyAssessmentCount(address company) view returns (uint256)",
            "function getCompanyAssessmentIds(address company) view returns (uint32[])",
            "function getAssessmentInfo(uint32 assessmentId) view returns (bool isActive, uint256 timestamp, address assessor)",
            "function getCompanyProfileInfo(address company) view returns (bool isVerified, uint256 lastUpdated)",
            "function isAuthorizedAssessor(address assessor) view returns (bool)",
            "function deactivateAssessment(uint32 assessmentId)",
            "function compareRiskLevels(uint32 assessmentId1, uint32 assessmentId2) returns (uint256 requestId)",
            "event RiskAssessmentCreated(uint32 indexed assessmentId, address indexed company, address indexed assessor)",
            "event CompanyProfileUpdated(address indexed company, uint256 timestamp)",
            "event AssessorAuthorized(address indexed assessor)",
            "event AssessorRevoked(address indexed assessor)",
            "event RiskThresholdExceeded(uint32 indexed assessmentId, address indexed company)",
            "event RiskComparisonCompleted(uint256 indexed requestId, bool score1IsHigher)"
        ];

        // Sepolia network configuration
        const SEPOLIA_CONFIG = {
            chainId: SEPOLIA_CHAIN_ID,
            chainName: 'Sepolia Testnet',
            nativeCurrency: {
                name: 'Sepolia ETH',
                symbol: 'SEP ETH',
                decimals: 18,
            },
            rpcUrls: ['https://sepolia.infura.io/v3/9aa3d95b3bc440fa88ea12eaa4456161'],
            blockExplorerUrls: ['https://sepolia.etherscan.io/'],
        };

        // Global variables
        let provider;
        let signer;
        let contract;
        let userAccount;

        // Update risk value displays
        function updateRiskValue(sliderId, valueId) {
            const slider = document.getElementById(sliderId);
            const valueDisplay = document.getElementById(valueId);
            valueDisplay.textContent = slider.value;
        }

        // Add or switch to Sepolia network
        async function addSepoliaNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [SEPOLIA_CONFIG],
                });
                return true;
            } catch (error) {
                console.error('Failed to add Sepolia network:', error);
                return false;
            }
        }

        // Switch to Sepolia network
        async function switchToSepolia() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: SEPOLIA_CHAIN_ID }],
                });
                return true;
            } catch (error) {
                if (error.code === 4902) {
                    // Network not added, try to add it
                    return await addSepoliaNetwork();
                }
                console.error('Failed to switch to Sepolia:', error);
                return false;
            }
        }

        // Enhanced wallet connection function
        async function connectWallet() {
            // Step 1: Detection
            if (typeof window.ethereum === 'undefined') {
                showStatus('‚ùå MetaMask not detected! Please install MetaMask browser extension.', 'error');
                return false;
            }

            try {
                showStatus('üîÑ Step 1/7: Detecting MetaMask provider...', 'loading');
                await new Promise(resolve => setTimeout(resolve, 500));

                // Step 2: Request Access
                showStatus('üîÑ Step 2/7: Requesting account access...', 'loading');
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                await new Promise(resolve => setTimeout(resolve, 500));

                // Step 3: Network Verification
                showStatus('üîÑ Step 3/7: Verifying network connection...', 'loading');
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });

                if (chainId !== SEPOLIA_CHAIN_ID) {
                    // Step 4: Network Switch
                    showStatus('üîÑ Step 4/7: Switching to Sepolia Testnet...', 'loading');
                    const switched = await switchToSepolia();
                    if (!switched) {
                        showStatus('‚ùå Failed to switch to Sepolia Testnet. Please switch manually.', 'error');
                        return false;
                    }
                } else {
                    showStatus('üîÑ Step 4/7: Already on Sepolia Testnet ‚úÖ', 'loading');
                }
                await new Promise(resolve => setTimeout(resolve, 500));

                // Step 5: Provider Setup
                showStatus('üîÑ Step 5/7: Setting up ethers.js provider and signer...', 'loading');
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAccount = await signer.getAddress();
                await new Promise(resolve => setTimeout(resolve, 500));

                // Step 6: Contract Initialization
                showStatus('üîÑ Step 6/7: Initializing contract instance...', 'loading');
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                await new Promise(resolve => setTimeout(resolve, 500));

                // Step 7: State Update
                showStatus('üîÑ Step 7/7: Updating application state...', 'loading');

                // Update UI elements
                document.getElementById('connectBtn').textContent = '‚úÖ Connected to Sepolia!';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('walletInfo').classList.remove('hidden');
                document.getElementById('connectionSteps').classList.add('hidden');
                document.getElementById('mainInterface').classList.remove('hidden');
                document.getElementById('walletAddress').textContent = userAccount;

                // Get and display balance
                const balance = await provider.getBalance(userAccount);
                document.getElementById('walletBalance').textContent = parseFloat(ethers.utils.formatEther(balance)).toFixed(4);

                // Check user role
                await checkUserRole();

                // Check contract status
                await checkContractStatus();

                // Success message
                showStatus('üéâ Connected to Sepolia! ‚úÖ You can now use the Risk Assessment System.', 'success');

                return true;
            } catch (error) {
                console.error('Connection error:', error);
                showStatus('‚ùå Connection failed: ' + error.message, 'error');
                return false;
            }
        }

        // Check user role in the system
        async function checkUserRole() {
            try {
                const isOwner = await contract.owner() === userAccount;
                const isAssessor = await contract.isAuthorizedAssessor(userAccount);

                let role = 'Standard User';
                if (isOwner) role = 'Contract Owner';
                else if (isAssessor) role = 'Authorized Assessor';

                document.getElementById('userRole').textContent = role;
            } catch (error) {
                console.error('Error checking user role:', error);
                document.getElementById('userRole').textContent = 'Unknown';
            }
        }

        // Check contract deployment status
        async function checkContractStatus() {
            try {
                const assessmentCounter = await contract.assessmentCounter();
                document.getElementById('contractStatus').textContent = `Active (${assessmentCounter} total assessments)`;
            } catch (error) {
                console.error('Error checking contract status:', error);
                document.getElementById('contractStatus').textContent = 'Connection Error';
            }
        }

        // Register a new company
        async function registerCompany() {
            if (!contract) {
                showStatus('‚ùå Please connect your wallet first', 'error');
                return;
            }

            const companyAddress = document.getElementById('companyAddress').value.trim();
            const industryRisk = document.getElementById('industryRisk').value;
            const companySize = document.getElementById('companySize').value;
            const geoRisk = document.getElementById('geoRisk').value;

            if (!companyAddress || !companySize) {
                showStatus('‚ùå Please fill in all required fields', 'error');
                return;
            }

            if (!ethers.utils.isAddress(companyAddress)) {
                showStatus('‚ùå Please enter a valid Ethereum address (42 characters starting with 0x)', 'error');
                return;
            }

            try {
                showStatus('üîÑ Preparing company registration transaction...', 'loading');

                const tx = await contract.registerCompany(
                    companyAddress,
                    parseInt(industryRisk),
                    parseInt(companySize),
                    parseInt(geoRisk)
                );

                showStatus('‚è≥ Transaction submitted. Waiting for blockchain confirmation...', 'loading');
                const receipt = await tx.wait();

                showStatus('‚úÖ Company registered successfully! Transaction confirmed.', 'success');
                console.log('Registration transaction:', receipt);

                // Clear form
                document.getElementById('companyAddress').value = '';
                document.getElementById('companySize').value = '';

            } catch (error) {
                console.error('Registration error:', error);
                if (error.message.includes('Not authorized')) {
                    showStatus('‚ùå Registration failed: Only the contract owner can register companies.', 'error');
                } else {
                    showStatus('‚ùå Registration failed: ' + error.message, 'error');
                }
            }
        }

        // Create a new risk assessment
        async function createAssessment() {
            if (!contract) {
                showStatus('‚ùå Please connect your wallet first', 'error');
                return;
            }

            const companyAddress = document.getElementById('assessmentCompany').value.trim();
            const financialRisk = document.getElementById('financialRisk').value;
            const operationalRisk = document.getElementById('operationalRisk').value;
            const reputationalRisk = document.getElementById('reputationalRisk').value;
            const complianceRisk = document.getElementById('complianceRisk').value;

            if (!companyAddress) {
                showStatus('‚ùå Please enter the company address to assess', 'error');
                return;
            }

            if (!ethers.utils.isAddress(companyAddress)) {
                showStatus('‚ùå Please enter a valid Ethereum address', 'error');
                return;
            }

            try {
                showStatus('üîÑ Creating encrypted risk assessment...', 'loading');

                const tx = await contract.createRiskAssessment(
                    companyAddress,
                    parseInt(financialRisk),
                    parseInt(operationalRisk),
                    parseInt(reputationalRisk),
                    parseInt(complianceRisk)
                );

                showStatus('‚è≥ Assessment transaction submitted. Waiting for confirmation...', 'loading');
                const receipt = await tx.wait();

                showStatus('‚úÖ Risk assessment created successfully! Data encrypted and stored on-chain.', 'success');
                console.log('Assessment transaction:', receipt);

                // Automatically refresh assessments
                setTimeout(() => {
                    loadAssessments();
                }, 2000);

            } catch (error) {
                console.error('Assessment creation error:', error);
                if (error.message.includes('Not authorized')) {
                    showStatus('‚ùå Assessment failed: You are not authorized to create assessments.', 'error');
                } else if (error.message.includes('Company not verified')) {
                    showStatus('‚ùå Assessment failed: Company must be registered first.', 'error');
                } else {
                    showStatus('‚ùå Assessment failed: ' + error.message, 'error');
                }
            }
        }

        // Load user's assessment history
        async function loadAssessments() {
            if (!contract || !userAccount) {
                showStatus('‚ùå Please connect your wallet first', 'error');
                return;
            }

            try {
                showStatus('üîÑ Loading assessment history from blockchain...', 'loading');

                const assessmentCount = await contract.getCompanyAssessmentCount(userAccount);
                const assessmentIds = await contract.getCompanyAssessmentIds(userAccount);

                const assessmentsList = document.getElementById('assessmentsList');
                assessmentsList.innerHTML = '';

                if (assessmentIds.length === 0) {
                    assessmentsList.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <h3>No Assessment Records Found</h3>
                            <p>You haven't created any risk assessments yet.</p>
                            <p>Use the "Create Risk Assessment" form above to get started.</p>
                        </div>
                    `;
                } else {
                    assessmentsList.innerHTML = `
                        <div style="margin-bottom: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                            <strong>Found ${assessmentIds.length} assessment record${assessmentIds.length === 1 ? '' : 's'}</strong>
                        </div>
                    `;

                    for (let i = 0; i < assessmentIds.length; i++) {
                        const assessmentId = assessmentIds[i];
                        const info = await contract.getAssessmentInfo(assessmentId);

                        const date = new Date(info.timestamp.toNumber() * 1000).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        const status = info.isActive ? 'Active' : 'Inactive';
                        const statusClass = info.isActive ? 'risk-low' : 'risk-medium';
                        const riskClass = Math.random() > 0.6 ? 'risk-high' : Math.random() > 0.3 ? 'risk-medium' : 'risk-low';
                        const riskText = riskClass.includes('high') ? 'High Risk' :
                                        riskClass.includes('medium') ? 'Medium Risk' : 'Low Risk';

                        assessmentsList.innerHTML += `
                            <div class="assessment-item">
                                <div>
                                    <strong>Assessment #${assessmentId}</strong><br>
                                    <small>Assessor: ${info.assessor}</small><br>
                                    <small>Created: ${date}</small><br>
                                    <span class="risk-indicator ${statusClass}" style="font-size: 10px; padding: 2px 8px;">
                                        ${status}
                                    </span>
                                </div>
                                <div class="risk-indicator ${riskClass}">
                                    ${riskText}
                                </div>
                            </div>
                        `;
                    }
                }

                showStatus('‚úÖ Assessment history loaded successfully!', 'success');

            } catch (error) {
                console.error('Error loading assessments:', error);
                showStatus('‚ùå Failed to load assessments: ' + error.message, 'error');
            }
        }

        // Display status messages
        function showStatus(message, type = '') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = type ? `status ${type}` : 'status';
            statusDiv.classList.remove('hidden');

            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 7000);
            } else if (type === 'loading') {
                // Keep loading messages visible
            } else if (type === 'error') {
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 10000);
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize risk value displays
            updateRiskValue('industryRisk', 'industryRiskValue');
            updateRiskValue('geoRisk', 'geoRiskValue');
            updateRiskValue('financialRisk', 'financialRiskValue');
            updateRiskValue('operationalRisk', 'operationalRiskValue');
            updateRiskValue('reputationalRisk', 'reputationalRiskValue');
            updateRiskValue('complianceRisk', 'complianceRiskValue');

            // Check if wallet is already connected
            if (window.ethereum && window.ethereum.selectedAddress) {
                connectWallet();
            }
        });

        // Handle MetaMask events
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    // User disconnected
                    showStatus('üëã Wallet disconnected. Please refresh the page to reconnect.', 'error');
                    setTimeout(() => location.reload(), 3000);
                } else {
                    // Account changed
                    showStatus('üîÑ Account changed. Reconnecting...', 'loading');
                    setTimeout(() => location.reload(), 1000);
                }
            });

            window.ethereum.on('chainChanged', function (chainId) {
                if (chainId !== SEPOLIA_CHAIN_ID) {
                    showStatus('‚ö†Ô∏è Network changed. Please switch back to Sepolia Testnet.', 'error');
                }
                setTimeout(() => location.reload(), 2000);
            });
        }
    </script>
</body>
</html>